===========================================
    Cáº¤U HÃŒNH SEPAY - HÆ I THá» XANH
===========================================

ğŸ“Œ THÃ”NG TIN TÃ€I KHOáº¢N HIá»†N Táº I
===========================================
TÃªn cÃ´ng ty: TTÄ
TÃ i khoáº£n ngÃ¢n hÃ ng: VPBank - 0888889805 - TRáº¦N THANH Äá»˜
GÃ³i dá»‹ch vá»¥: VPBank PRO
Dashboard: https://my.sepay.vn/

ğŸ“Œ THÃ”NG TIN ÄÃƒ Cáº¤U HÃŒNH
===========================================

1. WEBHOOK PRODUCTION
   - ID: 17017
   - TÃªn: hoithoxanh-production
   - URL: https://air-purifier-hcm.vercel.app/api/payment/sepay/webhook
   - Sá»± kiá»‡n: CÃ³ tiá»n vÃ o
   - TK ngÃ¢n hÃ ng: VPBank - 0888889805 - TRáº¦N THANH Äá»˜
   - Bá» qua náº¿u khÃ´ng cÃ³ Code: KhÃ´ng
   - XÃ¡c thá»±c: KhÃ´ng cáº§n chá»©ng thá»±c
   - Content type: application/json
   - Retry: HTTP Status Code khÃ´ng náº±m trong 200-299
   - Tráº¡ng thÃ¡i: KÃ­ch hoáº¡t âœ…

2. API ACCESS PRODUCTION
   - ID: 5175
   - TÃªn: hoithoxanh-production
   - API Token: AKXOSYVCCFNZSWHU8PRJQWPVPGGDZ0IDB72HBAHBFZ8MGK9DTN1AMDLONNFVOR4X
   - Tráº¡ng thÃ¡i: Hoáº¡t Ä‘á»™ng âœ…

3. ENVIRONMENT VARIABLES (VERCEL)
   - SEPAY_API_KEY: AKXOSYVCCFNZSWHU8PRJQWPVPGGDZ0IDB72HBAHBFZ8MGK9DTN1AMDLONNFVOR4X
   - Scope: Production

===========================================
ğŸ“– HÆ¯á»šNG DáºªN Cáº¤U HÃŒNH CHO TÃ€I KHOáº¢N Má»šI
===========================================

BÆ¯á»šC 1: ÄÄ‚NG NHáº¬P VÃ€ Láº¤Y THÃ”NG TIN
-------------------------------------------
1. ÄÄƒng nháº­p: https://my.sepay.vn/login
2. XÃ¡c nháº­n thÃ´ng tin:
   - TÃªn cÃ´ng ty/cÃ¡ nhÃ¢n
   - TÃ i khoáº£n ngÃ¢n hÃ ng Ä‘ang dÃ¹ng
   - GÃ³i dá»‹ch vá»¥ hiá»‡n táº¡i

BÆ¯á»šC 2: Táº O WEBHOOK
-------------------------------------------
1. VÃ o: https://my.sepay.vn/webhooks
2. Click "ThÃªm webhooks"
3. Äiá»n thÃ´ng tin:

   â”œâ”€ Äáº·t tÃªn: [TÃŠN_Dá»°_ÃN]-production
   â”‚  VD: hoithoxanh-production, shopbanhang-production
   â”‚
   â”œâ”€ [1] Chá»n sá»± kiá»‡n
   â”‚  â””â”€ Báº¯n WebHooks khi: "CÃ³ tiá»n vÃ o"
   â”‚
   â”œâ”€ [2] Chá»n Ä‘iá»u kiá»‡n  
   â”‚  â”œâ”€ Khi tÃ i khoáº£n ngÃ¢n hÃ ng lÃ : [Chá»n TK cá»§a báº¡n]
   â”‚  â””â”€ Bá» qua náº¿u khÃ´ng cÃ³ Code thanh toÃ¡n?: "KhÃ´ng"
   â”‚
   â”œâ”€ [3] Thuá»™c tÃ­nh WebHooks
   â”‚  â”œâ”€ Gá»i Ä‘áº¿n URL: https://[DOMAIN]/api/payment/sepay/webhook
   â”‚  â”‚  VD: https://yourdomain.vercel.app/api/payment/sepay/webhook
   â”‚  â”‚
   â”‚  â”œâ”€ LÃ  WebHooks xÃ¡c thá»±c thanh toÃ¡n?: "KhÃ´ng"
   â”‚  â””â”€ Gá»i láº¡i Webhooks khi?:
   â”‚     â˜‘ HTTP Status Code khÃ´ng náº±m trong 200-299
   â”‚
   â””â”€ [4] Cáº¥u hÃ¬nh chá»©ng thá»±c
      â”œâ”€ Kiá»ƒu chá»©ng thá»±c: "KhÃ´ng cáº§n chá»©ng thá»±c"
      â”œâ”€ Request Content type: "application/json"
      â””â”€ Tráº¡ng thÃ¡i: "KÃ­ch hoáº¡t"

4. Click "ThÃªm" Ä‘á»ƒ lÆ°u

BÆ¯á»šC 3: Táº O API ACCESS
-------------------------------------------
1. VÃ o: https://my.sepay.vn/companyapi
2. Click "ThÃªm API Access"
3. Äiá»n thÃ´ng tin:
   - TÃªn: [TÃŠN_Dá»°_ÃN]-production
   - Tráº¡ng thÃ¡i: "Hoáº¡t Ä‘á»™ng"
4. Click "ThÃªm"
5. **QUAN TRá»ŒNG:** Copy API Token ngay sau khi táº¡o
   - Token dáº¡ng: AKXOS...VOR4X (64 kÃ½ tá»±)
   - LÆ°u vÃ o nÆ¡i an toÃ n

BÆ¯á»šC 4: Cáº¤U HÃŒNH VERCEL ENVIRONMENT VARIABLES
-------------------------------------------
CÃ¡ch 1: DÃ¹ng CLI (Terminal)
```bash
cd /path/to/your/project
echo "YOUR_SEPAY_API_TOKEN" | vercel env add SEPAY_API_KEY production
```

CÃ¡ch 2: DÃ¹ng Vercel Dashboard
1. VÃ o: https://vercel.com/[team]/[project]/settings/environment-variables
2. Click "Add New"
3. Äiá»n:
   - Name: SEPAY_API_KEY
   - Value: [Paste API Token vá»«a copy]
   - Environment: Production
4. Click "Save"

BÆ¯á»šC 5: DEPLOY
-------------------------------------------
CÃ¡ch 1: Deploy qua Git (Khuyáº¿n nghá»‹)
```bash
git add .
git commit -m "feat: integrate Sepay payment"
git push origin main
```
â†’ Vercel tá»± Ä‘á»™ng deploy

CÃ¡ch 2: Deploy qua CLI
```bash
vercel --prod
```

BÆ¯á»šC 6: TEST THANH TOÃN
-------------------------------------------
1. VÃ o website production
2. ThÃªm sáº£n pháº©m vÃ o giá» hÃ ng
3. Checkout â†’ Chá»n "Thanh toÃ¡n online - Chuyá»ƒn khoáº£n"
4. Äiá»n thÃ´ng tin â†’ Äáº·t hÃ ng
5. ÄÆ°á»£c redirect Ä‘áº¿n trang Sepay
6. Chuyá»ƒn khoáº£n theo QR/thÃ´ng tin
7. Kiá»ƒm tra:
   âœ“ ÄÆ¡n hÃ ng tá»± Ä‘á»™ng cáº­p nháº­t tráº¡ng thÃ¡i
   âœ“ Webhook log trong Sepay Dashboard
   âœ“ Admin panel hiá»ƒn thá»‹ Ä‘Æ¡n hÃ ng

===========================================
ğŸ”§ Cáº¤U TRÃšC CODE (ÄÃƒ CÃ“ Sáº´N)
===========================================

FILE BACKEND API ROUTES:
â”œâ”€ app/api/payment/sepay/webhook/route.ts
â”‚  â””â”€ Nháº­n notification tá»« Sepay khi cÃ³ giao dá»‹ch
â”‚  â””â”€ Tá»± Ä‘á»™ng cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng
â”‚
â”œâ”€ app/api/payment/sepay/return/route.ts
â”‚  â””â”€ Xá»­ lÃ½ khi user quay vá» tá»« trang Sepay
â”‚
â”œâ”€ app/api/payment/sepay/create/route.ts
â”‚  â””â”€ Táº¡o phiÃªn thanh toÃ¡n Sepay
â”‚
â””â”€ app/api/orders/create/route.ts
   â””â”€ Táº¡o Ä‘Æ¡n hÃ ng trong database

FILE FRONTEND:
â”œâ”€ app/checkout/page.tsx
â”‚  â””â”€ Trang checkout vá»›i payment selection
â”‚
â”œâ”€ components/PaymentProcessing.tsx
â”‚  â””â”€ Modal hiá»ƒn thá»‹ khi Ä‘ang xá»­ lÃ½ thanh toÃ¡n
â”‚
â””â”€ components/PaymentForm.tsx
   â””â”€ Form chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n

FILE Cáº¤U HÃŒNH:
â”œâ”€ .env.local (Local development)
â”‚  SEPAY_API_KEY=sk_test_xxx...
â”‚  SEPAY_RETURN_URL=http://localhost:3000/api/payment/sepay/return
â”‚  SEPAY_WEBHOOK_URL=http://localhost:3000/api/payment/sepay/webhook
â”‚
â””â”€ Vercel Environment Variables (Production)
   SEPAY_API_KEY=AKXOSYVCCFNZSWHU8PRJQWPVPGGDZ0IDB72HBAHBFZ8MGK9DTN1AMDLONNFVOR4X
   (CÃ¡c URL tá»± Ä‘á»™ng dÃ¹ng production domain)

===========================================
âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG
===========================================

1. Báº¢O Máº¬T API KEY
   âœ— KHÃ”NG commit .env.local lÃªn Git
   âœ— KHÃ”NG share API Key cÃ´ng khai
   âœ“ Chá»‰ lÆ°u trong Vercel Environment Variables
   âœ“ Backup API Key á»Ÿ nÆ¡i an toÃ n

2. WEBHOOK URL
   âœ“ Pháº£i lÃ  HTTPS (production)
   âœ“ Pháº£i accessible tá»« internet
   âœ— Localhost khÃ´ng dÃ¹ng Ä‘Æ°á»£c (production)
   â†’ DÃ¹ng ngrok náº¿u test local: ngrok http 3000

3. RETURN URL
   âœ“ LÃ  URL Ä‘á»ƒ user quay vá» sau khi thanh toÃ¡n
   âœ“ KhÃ´ng báº¯t buá»™c pháº£i tráº£ vá» 200 OK
   â†’ Webhook má»›i lÃ  nÆ¡i cáº­p nháº­t Ä‘Æ¡n hÃ ng

4. WEBHOOK RESPONSE
   âœ“ Pháº£i return HTTP 200-299 Ä‘á»ƒ Sepay biáº¿t thÃ nh cÃ´ng
   âœ— Náº¿u fail, Sepay sáº½ retry theo config
   â†’ Code Ä‘Ã£ handle sáºµn

5. TESTING
   - Test local: DÃ¹ng ngrok expose localhost
   - Test staging: Deploy staging environment riÃªng
   - Test production: DÃ¹ng sá»‘ tiá»n nhá» Ä‘á»ƒ test tháº­t

6. MÃƒ THANH TOÃN
   - Format: HTX-[TIMESTAMP]
   - VD: HTX-1736024400123
   - ÄÆ°á»£c tá»± Ä‘á»™ng sinh trong code
   - Cáº¥u hÃ¬nh máº«u mÃ£ táº¡i: https://my.sepay.vn/company/configuration

===========================================
ğŸ†˜ TROUBLESHOOTING
===========================================

Váº¤N Äá»€ 1: Webhook khÃ´ng nháº­n Ä‘Æ°á»£c data
â”œâ”€ Kiá»ƒm tra URL webhook Ä‘Ãºng chÆ°a
â”œâ”€ Xem logs trong Sepay Dashboard â†’ Webhooks â†’ View logs
â”œâ”€ Test webhook endpoint: curl https://[domain]/api/payment/sepay/webhook
â””â”€ Verify Sepay cÃ³ gá»i Ä‘Æ°á»£c khÃ´ng (check Vercel logs)

Váº¤N Äá»€ 2: ÄÆ¡n hÃ ng khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t
â”œâ”€ Check webhook cÃ³ Ä‘Æ°á»£c gá»i khÃ´ng (Sepay logs)
â”œâ”€ Check response webhook cÃ³ 200 OK khÃ´ng
â”œâ”€ Verify database connection (Supabase)
â”œâ”€ Check RLS policies cho orders table
â””â”€ **FIX ÄÃƒ VERIFY:** DÃ¹ng direct query vá»›i .eq() vÃ  .single()

Váº¤N Äá»€ 5: Frontend khÃ´ng detect Ä‘Æ°á»£c payment status 'paid'
â”œâ”€ Admin page tháº¥y 'paid' nhÆ°ng check API tráº£ vá» 'pending'
â”œâ”€ **NGUYÃŠN NHÃ‚N:** Query logic phá»©c táº¡p, cÃ³ thá»ƒ read consistency issue
â”œâ”€ **SOLUTION:**
â”‚  1. Táº¡o script test local: scripts/test-find-order.js
â”‚  2. Verify query logic vá»›i SERVICE_ROLE_KEY
â”‚  3. DÃ¹ng direct query: .eq('order_number', code).single()
â”‚  4. Return NGAY khi tÃ¬m tháº¥y (early return)
â””â”€ **Káº¾T QUáº¢:** âœ… Hoáº¡t Ä‘á»™ng 100%

Váº¤N Äá»€ 6: Vercel build failed - Dependency conflicts
â”œâ”€ React 19 conflict vá»›i Next.js 15.0.3
â”œâ”€ Missing dependencies: class-variance-authority, clsx, tailwind-merge
â”œâ”€ Next.js 15 breaking change: params lÃ  Promise
â””â”€ **SOLUTION:**
   1. Táº¡o .npmrc vá»›i legacy-peer-deps=true
   2. npm install class-variance-authority clsx tailwind-merge
   3. Fix params type: params: Promise<{ slug: string }>
   4. Await params: const { slug } = await params

Váº¤N Äá»€ 3: KhÃ´ng redirect Ä‘Æ°á»£c vá» trang Sepay
â”œâ”€ Kiá»ƒm tra SEPAY_API_KEY Ä‘Ãºng chÆ°a
â”œâ”€ Verify SEPAY_ENDPOINT
â”œâ”€ Check browser console errors
â””â”€ Review Vercel function logs

Váº¤N Äá»€ 4: Deploy failed
â”œâ”€ Check git author cÃ³ quyá»n deploy khÃ´ng
â”œâ”€ Verify Vercel project settings
â”œâ”€ Push qua Git thay vÃ¬ CLI
â””â”€ Hoáº·c deploy trá»±c tiáº¿p trÃªn Vercel Dashboard

===========================================
ğŸ“š TÃ€I LIá»†U THAM KHáº¢O
===========================================

Sepay:
- Developer Docs: https://developer.sepay.vn/vi
- Dashboard: https://my.sepay.vn/
- Support: support@sepay.vn
- Hotline: 02873.059.589

Vercel:
- Dashboard: https://vercel.com/
- Docs: https://vercel.com/docs
- Environment Variables: https://vercel.com/docs/environment-variables

===========================================
ğŸ’¡ TIPS CHO CURSOR/AI ASSISTANT KHÃC
===========================================

Khi Ä‘Æ°á»£c yÃªu cáº§u setup Sepay cho dá»± Ã¡n má»›i:

1. Äá»ŒC FILE NÃ€Y trÆ°á»›c
2. Há»i user thÃ´ng tin:
   - Domain production lÃ  gÃ¬?
   - ÄÃ£ cÃ³ tÃ i khoáº£n Sepay chÆ°a?
   - TÃ i khoáº£n ngÃ¢n hÃ ng nÃ o?
3. Sá»­ dá»¥ng browser tools Ä‘á»ƒ:
   - Navigate Ä‘áº¿n https://my.sepay.vn/
   - Táº¡o webhook tá»± Ä‘á»™ng
   - Táº¡o API key tá»± Ä‘á»™ng
   - Copy thÃ´ng tin vá»
4. Cáº¥u hÃ¬nh Vercel env vars
5. Deploy vÃ  test

âš¡ DEBUGGING PAYMENT KHÃ”NG HOáº T Äá»˜NG:

1. **Táº O TEST SCRIPT TRÆ¯á»šC:**
   - Copy scripts/test-find-order.js
   - Test vá»›i SERVICE_ROLE_KEY
   - Verify query logic trÆ°á»›c khi debug production

2. **CHECK API LOGIC:**
   - DÃ¹ng DIRECT QUERY: .eq('order_number', code).single()
   - KHÃ”NG dÃ¹ng logic phá»©c táº¡p vá»›i .find() trÃªn array
   - Return NGAY khi tÃ¬m tháº¥y (early return)

3. **VERIFY DEPENDENCIES:**
   - Táº¡o .npmrc vá»›i legacy-peer-deps=true
   - Install: class-variance-authority, clsx, tailwind-merge
   - Fix Next.js 15 params: Promise<{ slug: string }>

4. **CHECK ENVIRONMENT:**
   - Verify Supabase URL Ä‘Ãºng project
   - Verify SERVICE_ROLE_KEY cÃ³ quyá»n
   - Check Vercel logs Ä‘á»ƒ xem total_orders

KHÃ”NG Táº O CÃC FILE .md HAY HÆ¯á»šNG DáºªN DÃ€I DÃ’NG
â†’ Chá»‰ cáº§n action trá»±c tiáº¿p vÃ  note láº¡i trong file .txt nÃ y

===========================================
ğŸ“ CHANGELOG
===========================================

2025-11-05: âœ… THANH TOÃN THÃ€NH CÃ”NG - SOLUTION HOÃ€N CHá»ˆNH
---------------------------------------------------------
Váº¤N Äá»€ ÄÃƒ GIáº¢I QUYáº¾T:
- API khÃ´ng tÃ¬m tháº¥y order dÃ¹ order tá»“n táº¡i trong Supabase
- Frontend popup khÃ´ng detect Ä‘Æ°á»£c payment_status = 'paid'
- Admin page tháº¥y order nhÆ°ng check API khÃ´ng tháº¥y

NGUYÃŠN NHÃ‚N:
1. Query logic phá»©c táº¡p vá»›i .find() trÃªn array
2. CÃ³ thá»ƒ cÃ³ váº¥n Ä‘á» vá» read consistency
3. Dependencies thiáº¿u khi deploy Vercel
4. Next.js 15 breaking changes

SOLUTION ÄÃƒ ÃP Dá»¤NG (HOáº T Äá»˜NG 100%):

1. **Test Script Local** (scripts/test-find-order.js)
   - Táº¡o script test Ä‘á»™c láº­p Ä‘á»ƒ verify logic
   - Test vá»›i SERVICE_ROLE_KEY â†’ âœ… TÃ¬m tháº¥y order
   - Test vá»›i ANON_KEY â†’ âŒ RLS blocking
   - Káº¿t luáº­n: Logic Ä‘Ãºng, cáº§n dÃ¹ng SERVICE_ROLE_KEY

2. **Fix Check API** (app/api/payment/sepay/check/route.ts)
   ```typescript
   // DÃ™NG DIRECT QUERY - Verified working
   const { data: directQuery, error: directError } = await supabase
     .from('orders')
     .select('*')
     .eq('order_number', orderNumber)
     .single(); // Use .single() thay vÃ¬ .maybeSingle()
   
   // Return NGAY náº¿u tÃ¬m tháº¥y
   if (directQuery && !directError) {
     return NextResponse.json({
       success: true,
       isPaid: directQuery.payment_status === 'paid',
       order: directQuery,
       payment_status: directQuery.payment_status,
       method: 'direct_query',
     });
   }
   ```

3. **Fix Build Dependencies**
   - Táº¡o `.npmrc` vá»›i `legacy-peer-deps=true`
   - Install: class-variance-authority, clsx, tailwind-merge
   - Fix Next.js 15: params â†’ Promise<params>

4. **Verify Environment Variables**
   - NEXT_PUBLIC_SUPABASE_URL Ä‘Ãºng
   - SUPABASE_SERVICE_ROLE_KEY Ä‘Ãºng
   - SEPAY_BANK_ACCOUNT, SEPAY_BANK_NAME Ä‘Ãºng

Káº¾T QUáº¢:
âœ… Webhook nháº­n tiá»n â†’ Update payment_status = 'paid'
âœ… Frontend click "ÄÃ£ thanh toÃ¡n" â†’ Detect Ä‘Æ°á»£c 'paid'
âœ… Redirect Ä‘áº¿n /success thÃ nh cÃ´ng
âœ… Admin page hiá»ƒn thá»‹ "ÄÃ£ thanh toÃ¡n"

FILES QUAN TRá»ŒNG ÄÃƒ Sá»¬A:
- app/api/payment/sepay/check/route.ts (Direct query logic)
- scripts/test-find-order.js (Test script)
- .npmrc (Fix dependency conflicts)
- package.json (Add missing dependencies)

2025-01-04:
- Initial setup cho hoithoxanh production
- Webhook ID: 17017
- API Key ID: 5175
- Deploy domain: air-purifier-hcm.vercel.app

===========================================
            Háº¾T TÃ€I LIá»†U
===========================================

